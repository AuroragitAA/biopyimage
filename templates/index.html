<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIOIMAGIN Optimized - Wolffia Cell Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #007bff;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #0056b3;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            font-size: 1.2em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .options {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #007bff;
        }

        .files-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .file-status {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-container {
            margin-top: 30px;
        }

        .result-item {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .visualization {
            text-align: center;
            margin: 25px 0;
        }

        .visualization img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tophat-training {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left-color: #ffc107;
        }

        .training-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .step-number {
            background: #ffc107;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .options {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-summary {
                grid-template-columns: 1fr;
            }

            .training-steps {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ BIOIMAGIN Optimized</h1>
            <p>Smart Wolffia Cell Analysis with AI-Powered Tophat Training</p>
        </div>

        <div class="main-content">
            <!-- Image Upload Section -->
            <div class="section">
                <h2>üì∏ Image Upload & Analysis</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-text">
                        <strong>Drop images here or click to select</strong><br>
                        Supports: PNG, JPG, JPEG, BMP, TIFF, JFIF (Max 50MB each)
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".png,.jpg,.jpeg,.bmp,.tiff,.tif,.jfif">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        üìÅ Select Images
                    </button>
                </div>



                <div class="options">
                    <div class="checkbox-container">
                        <input type="checkbox" id="useTophat">
                        <label for="useTophat"><strong>Use Tophat AI Model</strong> (if trained)</label>
                    </div>
                    
                    <!-- NEW: CellDetection option -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="useCellDetection" checked>
                        <label for="useCellDetection"><strong>Use CellDetection AI</strong> (deep learning)</label>
                    </div>
                    
                    <button class="btn btn-success" id="analyzeBtn" onclick="startAnalysis()" disabled>
                        üß¨ Start Analysis
                    </button>
                    
                    <!-- Status indicators -->
                    <div id="tophatStatus" class="alert alert-info" style="display: none;">
                        Checking Tophat model status...
                    </div>
                    
                    <!-- NEW: CellDetection status -->
                    <div id="celldetectionStatus" class="alert alert-info" style="display: none;">
                        Checking CellDetection model status...
                    </div>
                </div>


                <div class="files-list" id="filesList"></div>
            </div>

            <!-- Results Section -->
            <div class="section" id="resultsSection" style="display: none;">
                <h2>üìä Analysis Results</h2>
                <div class="results-container" id="resultsContainer"></div>
            </div>

            <!-- Tophat Training Section -->
            <div class="section tophat-training">
                <h2>üéØ Tophat AI Training</h2>
                <p>Train the AI to better detect cells by correcting automatic detections</p>

                <div class="training-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h4>Upload Images</h4>
                        <p>Upload multiple images for training</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h4>Review Detections</h4>
                        <p>Mark correct and incorrect cell detections</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h4>Train Model</h4>
                        <p>AI learns from your corrections</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" id="startTrainingBtn" onclick="startTophatTraining()" disabled>
                        üß† Start Training Session
                    </button>
                </div>

                <div id="trainingContainer" style="display: none; margin-top: 20px;">
                    <!-- Training interface will be loaded here -->
                </div>
            </div>

            

        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let analysisResults = {};
        let currentTrainingSession = null;

        // Check  model status on load
        function checkModelStatus() {
            // Check Tophat status
            fetch('/api/tophat/model_status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('tophatStatus');
                    const checkbox = document.getElementById('useTophat');
                    
                    if (data.model_available) {
                        statusDiv.innerHTML = '‚úÖ Tophat AI model is available';
                        statusDiv.className = 'alert alert-success';
                        checkbox.disabled = false;
                    } else {
                        statusDiv.innerHTML = '‚ö†Ô∏è No Tophat model trained yet. Use training section below.';
                        statusDiv.className = 'alert alert-info';
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    }
                    statusDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error checking Tophat status:', error);
                });
            
            // NEW: Check CellDetection status
            fetch('/api/celldetection/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('celldetectionStatus');
                    const checkbox = document.getElementById('useCellDetection');
                    
                    if (data.success && data.status.available && data.status.model_loaded) {
                        statusDiv.innerHTML = `‚úÖ CellDetection AI ready (${data.status.device.toUpperCase()})`;
                        statusDiv.className = 'alert alert-success';
                        checkbox.disabled = false;
                    } else if (data.success && data.status.available && !data.status.model_loaded) {
                        statusDiv.innerHTML = '‚ö†Ô∏è CellDetection available but model not loaded';
                        statusDiv.className = 'alert alert-warning';
                        checkbox.disabled = false;
                    } else {
                        statusDiv.innerHTML = '‚ùå CellDetection not available. Install: pip install celldetection';
                        statusDiv.className = 'alert alert-error';
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    }
                    statusDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error checking CellDetection status:', error);
                    const statusDiv = document.getElementById('celldetectionStatus');
                    statusDiv.innerHTML = '‚ùå Could not check CellDetection status';
                    statusDiv.className = 'alert alert-error';
                    statusDiv.style.display = 'block';
                });
        }

        // Update window load event
        window.addEventListener('load', checkModelStatus);  // 

        function checkTophatStatus() {
            fetch('/api/tophat/model_status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('tophatStatus');
                    const checkbox = document.getElementById('useTophat');
                    
                    if (data.model_available) {
                        statusDiv.innerHTML = '‚úÖ Tophat AI model is available';
                        statusDiv.className = 'alert alert-success';
                        checkbox.disabled = false;
                    } else {
                        statusDiv.innerHTML = '‚ö†Ô∏è No Tophat model trained yet. Use training section below.';
                        statusDiv.className = 'alert alert-info';
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    }
                    statusDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error checking Tophat status:', error);
                });
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            const validFiles = files.filter(file => {
                const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp', 'image/tiff'];
                return validTypes.includes(file.type) && file.size <= 50 * 1024 * 1024;
            });

            if (validFiles.length === 0) {
                alert('No valid image files selected. Please select PNG, JPG, BMP, or TIFF files under 50MB.');
                return;
            }

            // Upload files
            const formData = new FormData();
            validFiles.forEach(file => formData.append('files', file));
            formData.append('use_tophat', document.getElementById('useTophat').checked);

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedFiles = data.files;
                    displayFiles();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('startTrainingBtn').disabled = false;
                } else {
                    alert('Upload failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            });
        }

        function displayFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';

            uploadedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-status" id="status-${file.id}">Ready for analysis</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-${file.id}"></div>
                        </div>
                    </div>
                `;
                filesList.appendChild(fileItem);
            });
        }

        function startAnalysis() {
            document.getElementById('resultsSection').style.display = 'block';
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';

            // Add overall progress indicator
            const progressIndicator = document.createElement('div');
            progressIndicator.className = 'alert alert-info';
            progressIndicator.id = 'overall-progress';
            progressIndicator.innerHTML = `
                <h4>üìä Analyzing ${uploadedFiles.length} images...</h4>
                <div class="progress-bar" style="margin-top: 10px;">
                    <div class="progress-fill" id="overall-progress-fill" style="width: 0%;"></div>
                </div>
                <p style="margin-top: 10px;">Processing: <span id="current-progress">0</span> / ${uploadedFiles.length} completed</p>
            `;
            resultsContainer.appendChild(progressIndicator);

            // Track completion
            let completedAnalyses = 0;
            
            // Analyze each file
            uploadedFiles.forEach((file, index) => {
                setTimeout(() => {
                    analyzeFile(file, () => {
                        completedAnalyses++;
                        updateOverallProgress(completedAnalyses, uploadedFiles.length);
                        
                        if (completedAnalyses === uploadedFiles.length) {
                            // All analyses complete
                            setTimeout(() => {
                                const progressDiv = document.getElementById('overall-progress');
                                if (progressDiv) {
                                    progressDiv.innerHTML = `
                                        <h4>‚úÖ All analyses completed!</h4>
                                        <p>Successfully processed ${uploadedFiles.length} images.</p>
                                    `;
                                    progressDiv.className = 'alert alert-success';
                                }
                            }, 1000);
                        }
                    });
                }, index * 100); // Stagger the starts slightly
            });
        }

        function updateOverallProgress(completed, total) {
            const progressFill = document.getElementById('overall-progress-fill');
            const currentProgress = document.getElementById('current-progress');
            
            if (progressFill) {
                const percentage = (completed / total) * 100;
                progressFill.style.width = `${percentage}%`;
            }
            
            if (currentProgress) {
                currentProgress.textContent = completed;
            }
        }

        function analyzeFile(file, onComplete) {
            const statusElement = document.getElementById(`status-${file.id}`);
            const progressElement = document.getElementById(`progress-${file.id}`);
            
            statusElement.textContent = 'Starting analysis...';
            progressElement.style.width = '10%';

            // Get analysis options
            const useTophat = document.getElementById('useTophat').checked;
            const useCellDetection = document.getElementById('useCellDetection').checked;

            // Start analysis with options
            fetch(`/api/analyze/${file.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    files: [file],
                    use_tophat: useTophat,
                    use_celldetection: useCellDetection  // NEW option
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    pollAnalysisStatus(file.id, file.filename, onComplete);
                } else {
                    statusElement.textContent = 'Analysis failed: ' + data.error;
                    statusElement.style.color = 'red';
                    if (onComplete) onComplete();
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                statusElement.textContent = 'Analysis failed';
                statusElement.style.color = 'red';
                if (onComplete) onComplete();
            });
        }

        function pollAnalysisStatus(analysisId, filename, onComplete) {
            const statusElement = document.getElementById(`status-${analysisId}`);
            const progressElement = document.getElementById(`progress-${analysisId}`);

            const poll = () => {
                fetch(`/api/status/${analysisId}`)
                    .then(response => response.json())
                    .then(data => {
                        progressElement.style.width = data.progress + '%';
                        
                        if (data.status === 'completed') {
                            statusElement.textContent = 'Analysis completed';
                            statusElement.style.color = 'green';
                            progressElement.style.width = '100%';
                            displayResults(analysisId, filename, data.result);
                            if (onComplete) onComplete();
                        } else if (data.status === 'error') {
                            statusElement.textContent = 'Analysis failed: ' + data.error;
                            statusElement.style.color = 'red';
                            if (onComplete) onComplete();
                        } else {
                            statusElement.textContent = 'Processing...';
                            setTimeout(poll, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                        statusElement.textContent = 'Status check failed';
                        statusElement.style.color = 'red';
                        if (onComplete) onComplete();
                    });
            };

            poll();
        }

        function displayResults(analysisId, filename, result) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Create safe values with fallbacks
            const cellsDetected = result.cells_detected || 0;
            const totalArea = result.total_cell_area || 0;
            const avgArea = result.average_cell_area || 0;
            const processingTime = result.processing_time || 0;
            
            // Extract method information
            let detectionMethods = [];
            let primaryMethod = "Unknown";
            
            if (result.cells_data && result.cells_data.length > 0) {
                // Analyze methods used
                const methodCounts = {};
                result.cells_data.forEach(cell => {
                    const method = cell.method || 'unknown';
                    methodCounts[method] = (methodCounts[method] || 0) + 1;
                });
                
                // Find primary method (most cells)
                primaryMethod = Object.keys(methodCounts).reduce((a, b) => 
                    methodCounts[a] > methodCounts[b] ? a : b, 'unknown');
                
                detectionMethods = Object.entries(methodCounts).map(([method, count]) => 
                    `${method}: ${count} cells`);
            }
            
            // Enhanced metrics display
            const enhancedMetrics = result.enhanced_metrics || {};
            const biomassAnalysis = enhancedMetrics.biomass_analysis || {};
            const colorAnalysis = enhancedMetrics.color_analysis || {};
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
                <h3>üìÑ ${filename}</h3>
                
                <!-- Detection Method Info -->
                <div class="detection-info" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Detection Method</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div>
                            <strong>Primary Method:</strong><br>
                            <span style="color: ${primaryMethod.includes('celldetection') ? '#4caf50' : '#ff9800'};">
                                ${primaryMethod.replace('_', ' ').toUpperCase()}
                                ${primaryMethod.includes('celldetection') ? ' üß†' : ' üîß'}
                            </span>
                        </div>
                        <div>
                            <strong>Methods Used:</strong><br>
                            ${detectionMethods.join('<br>')}
                        </div>
                    </div>
                </div>
                
                <!-- Basic Metrics -->
                <div class="result-summary">
                    <div class="metric-card">
                        <div class="metric-value">${cellsDetected}</div>
                        <div class="metric-label">Cells Detected</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${totalArea.toFixed(0)}</div>
                        <div class="metric-label">Total Cell Area (px¬≤)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${avgArea.toFixed(1)}</div>
                        <div class="metric-label">Average Cell Area (px¬≤)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${processingTime.toFixed(2)}s</div>
                        <div class="metric-label">Processing Time</div>
                    </div>
                </div>

                <!-- Enhanced Metrics (if available) -->
                ${Object.keys(biomassAnalysis).length > 0 ? `
                <h4>üß¨ Biomass Analysis</h4>
                <div class="result-summary">
                    <div class="metric-card" style="background: linear-gradient(135deg, #4CAF50, #66BB6A);">
                        <div class="metric-value">${biomassAnalysis.total_biomass_mg?.toFixed(3) || '0.000'}</div>
                        <div class="metric-label">Total Biomass (mg)</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #8BC34A, #AED581);">
                        <div class="metric-value">${biomassAnalysis.average_biomass_mg?.toFixed(4) || '0.0000'}</div>
                        <div class="metric-label">Average Biomass (mg)</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #2E7D32, #388E3C);">
                        <div class="metric-value">${biomassAnalysis.total_chlorophyll_mg?.toFixed(4) || '0.0000'}</div>
                        <div class="metric-label">Total Chlorophyll (mg)</div>
                    </div>
                </div>
                ` : ''}

                <!-- Visualization -->
                <div class="visualization">
                    ${result.visualization ? 
                        `<img src="data:image/png;base64,${result.visualization}" 
                            alt="Cell Detection Results for ${filename}"
                            style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">` :
                        `<div style="background: #f8f9fa; padding: 40px; border-radius: 8px; text-align: center; color: #666;">
                            <h4>‚úÖ Analysis Completed Successfully</h4>
                            <p>Detected ${cellsDetected} cells using ${primaryMethod.replace('_', ' ')} method.</p>
                        </div>`
                    }
                </div>

                <!-- Export Buttons -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="exportResults('${analysisId}', 'csv')">üìä Export CSV</button>
                    <button class="btn" onclick="exportResults('${analysisId}', 'json')">üìÑ Export JSON</button>
                    ${biomassAnalysis.total_biomass_mg ? 
                        `<button class="btn btn-success" onclick="exportResults('${analysisId}', 'biomass_report')">üß¨ Biomass Report</button>` : ''
                    }
                </div>
            `;
            
            resultsContainer.appendChild(resultItem);
            resultItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // NEW: Function to download comprehensive biomass report
        function downloadBiomassReport(analysisId, filename) {
            // This will trigger a new endpoint for comprehensive biomass reports
            window.open(`/api/export/${analysisId}/biomass_report`, '_blank');
        }

        function exportResults(analysisId, format) {
            window.open(`/api/export/${analysisId}/${format}`, '_blank');
        }

        function startTophatTraining() {
            if (uploadedFiles.length === 0) {
                alert('Please upload images first');
                return;
            }

            const trainingContainer = document.getElementById('trainingContainer');
            trainingContainer.style.display = 'block';
            trainingContainer.innerHTML = '<p>Starting training session...</p>';

            fetch('/api/tophat/start_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: uploadedFiles })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTrainingSession = data.session;
                    displayTrainingInterface(data.session);
                } else {
                    trainingContainer.innerHTML = `<div class="alert alert-error">Training failed: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Training start error:', error);
                trainingContainer.innerHTML = '<div class="alert alert-error">Failed to start training session</div>';
            });
        }

        function displayTrainingInterface(session) {
            const trainingContainer = document.getElementById('trainingContainer');
            
            let html = `
                <div class="alert alert-success">
                    Training session started with ${session.images_count} images
                </div>
                <p><strong>Instructions:</strong> For each image, you will draw directly on the image to mark correct cells (green) and false positives (red). This trains the AI to recognize cell patterns.</p>
                
                <div class="training-legend" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4>üé® Drawing Instructions:</h4>
                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #28a745; border-radius: 50%;"></div>
                            <span><strong>Green:</strong> Draw around correct cells</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%;"></div>
                            <span><strong>Red:</strong> Draw around false positives</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: #007bff; border-radius: 50%;"></div>
                            <span><strong>Blue:</strong> Draw around missed cells</span>
                        </div>
                    </div>
                </div>
            `;

            session.images.forEach((image, index) => {
                html += `
                    <div class="result-item">
                        <h4>Image ${index + 1}: ${image.filename}</h4>
                        <p>Auto-detected cells: ${image.cells_count}</p>
                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn btn-warning" onclick="startDrawingAnnotation(${index})">
                                üé® Start Drawing Annotations
                            </button>
                        </div>
                        <div id="annotation-${index}" style="display: none;"></div>
                    </div>
                `;
            });

            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="finalizeTraining()">
                        üß† Finalize Training
                    </button>
                </div>
            `;

            trainingContainer.innerHTML = html;
        }

        function startDrawingAnnotation(imageIndex) {
            const annotationDiv = document.getElementById(`annotation-${imageIndex}`);
            annotationDiv.style.display = 'block';
            
            // Get the original image from the training session
            const image = currentTrainingSession.images[imageIndex];
            
            annotationDiv.innerHTML = `
                <div class="drawing-interface" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="drawing-controls" style="text-align: center; margin-bottom: 20px;">
                        <h4>üé® Drawing Tools</h4>
                        <div style="display: flex; justify-content: center; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="setDrawingMode(${imageIndex}, 'correct')" id="correct-btn-${imageIndex}">
                                ‚úÖ Mark Correct Cells
                            </button>
                            <button class="btn btn-danger" onclick="setDrawingMode(${imageIndex}, 'false_positive')" id="false-btn-${imageIndex}">
                                ‚ùå Mark False Positives
                            </button>
                            <button class="btn btn-primary" onclick="setDrawingMode(${imageIndex}, 'missed')" id="missed-btn-${imageIndex}">
                                üîç Mark Missed Cells
                            </button>
                            <button class="btn" onclick="clearDrawing(${imageIndex})" style="background: #6c757d; color: white;">
                                üóëÔ∏è Clear All
                            </button>
                        </div>
                        <p style="color: #666; margin: 10px 0;">
                            <strong>Instructions:</strong> Select a tool above, then draw circles around cells on the image below.
                        </p>
                    </div>
                    
                    <div style="text-align: center; position: relative; display: inline-block;">
                        <canvas id="drawing-canvas-${imageIndex}" 
                                style="border: 2px solid #007bff; border-radius: 8px; cursor: crosshair; max-width: 100%;"
                                onmousedown="startDrawing(event, ${imageIndex})"
                                onmousemove="draw(event, ${imageIndex})"
                                onmouseup="stopDrawing(${imageIndex})"
                                onmouseleave="stopDrawing(${imageIndex})">
                        </canvas>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-warning" onclick="saveDrawingAnnotations(${imageIndex})">
                            üíæ Save Annotations for this Image
                        </button>
                    </div>
                </div>
            `;
            
            // Load the original image onto the canvas
            loadImageToCanvas(imageIndex, image);
        }

        function finalizeTraining() {
            if (!currentTrainingSession) {
                alert('No active training session');
                return;
            }

            fetch('/api/tophat/train_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: currentTrainingSession.id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Tophat AI model trained successfully! You can now use it for analysis.');
                    checkTophatStatus(); // Refresh status
                } else {
                    alert('Training failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Training finalization error:', error);
                alert('Training finalization failed');
            });
        }

        // Drawing functionality for tophat training
        let drawingState = {};
        let annotations = {};

        function loadImageToCanvas(imageIndex, imageData) {
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const ctx = canvas.getContext('2d');
            
            // Create an image element to load the original image
            const img = new Image();
            img.onload = function() {
                // Set canvas size to match image
                canvas.width = Math.min(img.width, 800); // Max width for display
                canvas.height = (canvas.width / img.width) * img.height;
                
                // Draw the original image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Initialize drawing state
                drawingState[imageIndex] = {
                    isDrawing: false,
                    mode: 'correct',
                    lastX: 0,
                    lastY: 0
                };
                
                // Initialize annotations
                annotations[imageIndex] = {
                    correct: [],
                    false_positive: [],
                    missed: []
                };
                
                // Overlay detected cells if available
                if (imageData.image_data && imageData.image_data.visualization) {
                    overlayDetectedCells(imageIndex, imageData.image_data.cells_data);
                }
            };
            
            // Load image from the analysis result or create a data URL
            if (imageData.image_data && imageData.image_data.visualization) {
                img.src = `data:image/png;base64,${imageData.image_data.visualization}`;
            } else {
                // Load original image - handle both local paths and server paths
                const imagePath = imageData.path;
                if (imagePath.includes('uploads/')) {
                    // Server uploaded file
                    const filename = imagePath.split('/').pop();
                    img.src = `/uploads/${filename}`;
                } else {
                    // Direct path
                    img.src = imagePath;
                }
            }
        }

        function overlayDetectedCells(imageIndex, cellsData) {
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const ctx = canvas.getContext('2d');
            
            if (!cellsData || cellsData.length === 0) return;
            
            // Draw detected cell boundaries in light gray
            ctx.strokeStyle = 'rgba(128, 128, 128, 0.5)';
            ctx.lineWidth = 1;
            
            cellsData.forEach(cell => {
                if (cell.contour && cell.contour.length > 0) {
                    ctx.beginPath();
                    const contour = cell.contour;
                    
                    // Scale contour to canvas size
                    const scaleX = canvas.width / (cell.image_width || canvas.width);
                    const scaleY = canvas.height / (cell.image_height || canvas.height);
                    
                    contour.forEach((point, index) => {
                        const x = point[0] * scaleX;
                        const y = point[1] * scaleY;
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.closePath();
                    ctx.stroke();
                }
            });
        }

        function setDrawingMode(imageIndex, mode) {
            if (!drawingState[imageIndex]) return;
            
            drawingState[imageIndex].mode = mode;
            
            // Update button styles
            const buttons = {
                'correct': document.getElementById(`correct-btn-${imageIndex}`),
                'false_positive': document.getElementById(`false-btn-${imageIndex}`),
                'missed': document.getElementById(`missed-btn-${imageIndex}`)
            };
            
            // Reset all button styles
            Object.values(buttons).forEach(btn => {
                if (btn) btn.style.transform = 'scale(1)';
            });
            
            // Highlight selected button
            if (buttons[mode]) {
                buttons[mode].style.transform = 'scale(1.1)';
            }
            
            // Update cursor and canvas style based on mode
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const colors = {
                'correct': '#28a745',
                'false_positive': '#dc3545',
                'missed': '#007bff'
            };
            
            canvas.style.borderColor = colors[mode];
        }

        function startDrawing(event, imageIndex) {
            if (!drawingState[imageIndex]) return;
            
            drawingState[imageIndex].isDrawing = true;
            const rect = event.target.getBoundingClientRect();
            drawingState[imageIndex].lastX = event.clientX - rect.left;
            drawingState[imageIndex].lastY = event.clientY - rect.top;
        }

        function draw(event, imageIndex) {
            if (!drawingState[imageIndex] || !drawingState[imageIndex].isDrawing) return;
            
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            const currentX = event.clientX - rect.left;
            const currentY = event.clientY - rect.top;
            
            const colors = {
                'correct': '#28a745',
                'false_positive': '#dc3545',
                'missed': '#007bff'
            };
            
            ctx.strokeStyle = colors[drawingState[imageIndex].mode];
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            
            ctx.beginPath();
            ctx.moveTo(drawingState[imageIndex].lastX, drawingState[imageIndex].lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            drawingState[imageIndex].lastX = currentX;
            drawingState[imageIndex].lastY = currentY;
        }

        function stopDrawing(imageIndex) {
            if (!drawingState[imageIndex]) return;
            drawingState[imageIndex].isDrawing = false;
        }

        function clearDrawing(imageIndex) {
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const ctx = canvas.getContext('2d');
            
            // Reload the original image
            const image = currentTrainingSession.images[imageIndex];
            loadImageToCanvas(imageIndex, image);
            
            // Clear annotations
            annotations[imageIndex] = {
                correct: [],
                false_positive: [],
                missed: []
            };
        }

        function saveDrawingAnnotations(imageIndex) {
            if (!annotations[imageIndex]) {
                alert('No annotations to save');
                return;
            }
            
            const canvas = document.getElementById(`drawing-canvas-${imageIndex}`);
            const imageData = canvas.toDataURL('image/png');
            
            // Extract annotation data from canvas
            const annotationData = {
                session_id: currentTrainingSession.id,
                image_index: imageIndex,
                image_filename: currentTrainingSession.images[imageIndex].filename,
                annotations: annotations[imageIndex],
                annotated_image: imageData
            };
            
            // Save to server
            fetch('/api/tophat/save_annotations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(annotationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Annotations saved successfully!');
                    // Show success indicator
                    const saveBtn = document.querySelector(`#annotation-${imageIndex} .btn-warning`);
                    if (saveBtn) {
                        saveBtn.innerHTML = '‚úÖ Annotations Saved';
                        saveBtn.className = 'btn btn-success';
                        saveBtn.disabled = true;
                    }
                } else {
                    alert('Failed to save annotations: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Annotation save error:', error);
                alert('Failed to save annotations');
            });
        }
    </script>
</body>
</html>